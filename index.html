<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Content-Security-Policy"
            content="default-src 'none'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://esm.sh; style-src 'unsafe-inline'; img-src 'self'; manifest-src 'self'; connect-src 'self' https://cdn.jsdelivr.net https://esm.sh; worker-src blob:; frame-src blob:; base-uri 'none'; form-action 'none';">
        <script type="importmap">
        {
            "imports": {
                "@polkadot/util": "./libs/@polkadot_util@13.4.4/index.js",
                "@polkadot/util-crypto": "./libs/@polkadot_util-crypto@13.4.4/index.js",
                "@polkadot/wasm-crypto": "./libs/@polkadot_wasm-crypto@7.4.1/index.js",
                "@polkadot/wasm-bridge": "./libs/@polkadot_wasm-bridge@7.4.1/index.js",
                "@polkadot/wasm-util": "./libs/@polkadot_wasm-util@7.4.1/index.js",
                "@polkadot/networks": "./libs/npm/@polkadot/networks@13.4.4/+esm.js",
                "@polkadot/x-bigint": "./libs/npm/@polkadot/x-bigint@13.4.4/+esm.js",
                "@noble/hashes": "./libs/@noble_hashes_utils@1.7.1.js",
                "@noble/curves": "./libs/@noble_curves_secp256k1.js",
                "@scure/base": "./libs/@scure_base@1.2.4.js",
                "@scure/bip32": "./libs/@scure_bip32@1.6.2.js",
                "@scure/bip39": "./libs/@scure_bip39@1.5.4.js",
                "tweetnacl": "./libs/tweetnacl@1.0.3.js"
            }
        }
        </script>
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16x16.png">
    <link rel="manifest" href="./assets/site.webmanifest">
    <meta name="theme-color" content="#0d1117">
    <title>Enjin Snap Wallet Exporter</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root { --topbar-height: 56px; --footer-height: 44px; }

        /* Sticky topbar styles */
        .topbar {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1200;
            background: linear-gradient(180deg, rgba(13,17,23,0.98), rgba(13,17,23,0.95));
            border-bottom: 1px solid rgba(48,54,61,0.8);
            backdrop-filter: blur(6px);
        }
        .topbar-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 1.25rem;
            height: var(--topbar-height);
        }
        .topbar-left { display:flex; align-items:center; gap:12px; }
        .topbar-actions { display:flex; align-items:center; gap:8px; }
        /* Footer bar (full-width) */
        .footerbar {
            /* Fix to viewport bottom so it visually sticks to the bottom edge */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1200;
            background: linear-gradient(0deg, rgba(13,17,23,0.98), rgba(13,17,23,0.95));
            border-top: 1px solid rgba(48,54,61,0.8);
            backdrop-filter: blur(6px);
        }
        /* Reset the generic footer spacing when using the fixed footerbar
           and keep the inner container compact so the bar sits flush. */
        footer.footerbar { margin-top: 0; padding-top: 0; }
        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 0.75rem; /* reduced horizontal padding for slimmer bar */
            height: var(--footer-height);
        }
        .footer-text { font-size: 0.8rem; color: #8b949e; text-align: center; width: 100%; }
        .topbar-title { font-weight: 700; font-size: 1.4rem; color: #e6edf3; }
        .topbar-subtitle { font-size: 0.9rem; color: #8b949e; }
        .topbar-actions .btn-sm { background: transparent; border: 1px solid rgba(48,54,61,0.6); color: #58a6ff; padding: 0.35rem 0.65rem; }
        /* Ensure page content avoids topbar and footer */
        body { padding: 0 1.5rem calc(1.5rem + var(--footer-height)); }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
            /* ensure we keep space at the bottom so content isn't hidden beneath the fixed footer */
            padding: 0 1.5rem calc(1.5rem + var(--footer-height));
        }

        .container { max-width: 720px; margin: 0 auto; }

        h1 { font-size: 1.6rem; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.75rem; }
        .site-logo { width: 28px; height: 28px; object-fit: cover; border-radius: 6px; }
        .subtitle { color: #8b949e; margin-bottom: 1.5rem; font-size: 0.95rem; }

        .warning {
            background: #3d1f00;
            border: 1px solid #d29922;
            border-radius: 8px;
            padding: 0.9rem 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .status {
            background: rgba(34,197,94,0.10); /* transparent green */
            border: 1px solid #16a34a; /* solid green */
            border-radius: 8px;
            padding: 0.9rem 1rem;
            margin-bottom: 1.5rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #dff7ea;
        }

        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
        }
        .card h2 { font-size: 1.1rem; margin-bottom: 0.75rem; }

        textarea, input[type="password"], input[type="text"] {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            padding: 0.6rem 0.75rem;
            font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
            font-size: 0.85rem;
            resize: vertical;
        }
        .input-hint {
            font-size: 0.82rem;
            color: #8b949e;
            margin-top: 0.45rem;
            margin-bottom: 0.6rem;
        }
        .required { color: #ff6b6b; font-weight: 600; margin-left: 0.35rem; }
        .required-note { font-size: 0.82rem; color: #ff4d4f; margin-top: 0.35rem; margin-bottom: 0.6rem; }
        .field-note { font-size: 0.82rem; color: #ff4d4f; margin-top: 0.35rem; margin-bottom: 0.6rem; }
        .password-row { display: flex; gap: 0.5rem; align-items: center; }
        .password-input-wrapper { position: relative; width: 50%; }
        .password-input-wrapper input { width: 100%; padding-right: 2.75rem; }
        .password-input-wrapper .input-icon { position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; padding: 0.25rem; height: 36px; width: 36px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; color: #c9d1d9; }
        .password-input-wrapper .input-icon svg { width: 18px; height: 18px; display: block; }
        textarea:focus, input:focus { outline: none; border-color: #58a6ff; }

        button {
            background: #238636;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.55rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 0.75rem;
        }
        button:hover { background: #2ea043; }
                button:disabled { background: #21262d; color: #484f58; cursor: not-allowed; }
                /* Ensure disabled buttons do not change on hover */
                button:disabled:hover,
                button[disabled]:hover,
                .btn-download:disabled:hover,
                .btn-sm:disabled:hover {
                    background: #21262d;
                    color: #484f58;
                    cursor: not-allowed;
                }

        .btn-sm {
            background: transparent;
            border: 1px solid #30363d;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            margin: 0;
            flex-shrink: 0;
        }
        .btn-sm:hover { background: #30363d; }

        /* Make small buttons visually consistent with primary buttons inside cards */
        .card .btn-sm {
            padding: 0.45rem 0.75rem;
            display: inline-flex;
            align-items: center;
            height: 36px;
            border-radius: 6px;
        }

        .card button {
            height: 36px;
            margin-top: 0;
        }

        /* Style the primary Derive Addresses button: spacing + blue (non-green) variant */
        .card #deriveBtn {
            margin-top: 0.9rem;
            background: #2563eb;
            color: #ffffff;
            border: none;
        }
        .card #deriveBtn:hover { background: #1f53d2; }
        .card #deriveBtn:focus-visible { outline: 2px solid #58a6ff; outline-offset: 2px; }

        .btn-download {
            min-width: 220px;
            text-align: center;
        }

        .instructions {
            margin-top: 0.75rem;
            padding: 0.6rem 0.75rem;
            background: #0d1117;
            border-radius: 6px;
            font-size: 0.8rem;
            color: #8b949e;
            line-height: 1.5;
        }
        .instructions p { margin-bottom: 0.4rem; }
        .instructions p:last-child { margin-bottom: 0; }
        .instructions ol {
            margin: 0.3rem 0 0 1.2rem;
            padding: 0;
        }
        .instructions li {
            margin-bottom: 0.25rem;
        }
        .instructions em {
            color: #79c0ff;
            font-style: normal;
        }

        .result-group { margin-bottom: 1rem; }
        .result-group label {
            display: block;
            color: #8b949e;
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
        }
        .result-value {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 0.45rem 0.6rem;
            position: relative; /* allow absolute icons inside */
            padding-right: 4.6rem; /* room for inline action icons */
        }
        .result-value code {
            flex: 1;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.82rem;
            word-break: break-all;
            color: #79c0ff;
        }
        .result-value code { padding-right: 0.5rem; }

        /* Inline icon buttons placed inside result fields */
        .result-value .field-icon {
            position: absolute;
            right: 0.5rem; /* default: right-most */
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            padding: 0.25rem;
            height: 36px;
            width: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #c9d1d9;
            border-radius: 6px;
        }
        .result-value .field-icon svg { width: 18px; height: 18px; display: block; }
        /* Explicit positions: copy icon at right-most, toggle (eye) sits to its left */
        .result-value .field-icon.copy-icon { right: 0.5rem; }
        .result-value .field-icon.toggle-icon { right: 2rem; }
        .sensitive code { color: #f0883e; }

        .input-group { margin-bottom: 0.75rem; }
        .input-group label {
            display: block;
            color: #8b949e;
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
        }

        .unavailable {
            color: #484f58;
            font-style: italic;
            font-size: 0.85rem;
        }

        #loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            color: #8b949e;
        }
        .spinner {
            width: 32px; height: 32px;
            border: 3px solid #30363d;
            border-top-color: #58a6ff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error { color: #f85149; font-size: 0.85rem; margin-top: 0.5rem; }
        .success { color: #3fb950; font-size: 0.85rem; margin-top: 0.5rem; }

        footer {
            text-align: center;
            color: #484f58;
            font-size: 0.8rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #21262d;
        }

        /* ─── Modal System ────────────────────────────────── */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(1, 4, 9, 0.75);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 250ms ease, visibility 250ms ease;
            padding: 1rem;
        }
        .modal-overlay.is-visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-dialog {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            width: 100%;
            max-width: 440px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 16px 48px rgba(1, 4, 9, 0.6);
            transform: scale(0.95) translateY(8px);
            transition: transform 250ms ease;
        }
        .modal-overlay.is-visible .modal-dialog {
            transform: scale(1) translateY(0);
        }
        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px 24px 0;
        }
                .modal-body p {
                    text-align: justify;
                    text-justify: inter-word;
                    margin-bottom: 0.75rem;
                    text-align: justify;
                    margin-bottom: 0.75rem;
                }
                .modal-body p:last-child {
                    margin-bottom: 0;
                }
                    padding-bottom: 0px;
                    padding-left: 24px;
                    font-size: 0.9rem;
                    line-height: 1.6;
                    color: rgb(139, 148, 158);
                }
                /* Make modal paragraphs justified and add breathing room */
                .modal-body p {
                    text-align: justify;
                    text-justify: inter-word;
                    margin-bottom: 0.75rem;
                }
        .modal-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1.25rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        .modal-icon.info    { background: rgba(88, 166, 255, 0.2); color: #58a6ff; }
        .modal-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: #e6edf3;
        }
        .modal-body {
            padding: 16px 24px 0 24px;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #8b949e;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding: 0 24px 20px;
        }
        .modal-btn {
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background 150ms ease;
            min-height: 36px;
        }
        .modal-btn-primary {
            background: #238636;
            color: #fff;
        }
        .modal-btn-primary:hover { background: #2ea043; }
        .modal-btn-primary:focus-visible {
            outline: 2px solid #58a6ff;
            outline-offset: 2px;
        }
        .modal-btn-secondary {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }
        .modal-btn-secondary:hover { background: #30363d; }
        .modal-btn-danger {
            background: #da3633;
            color: #fff;
        }
        .modal-btn-danger:hover { background: #f85149; }
        .modal-close {
            position: static;
            margin-left: auto;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: #8b949e;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 150ms ease, color 150ms ease;
            line-height: 1;
            padding: 0;
        }
        .modal-close:hover { background: #21262d; color: #e6edf3; }
        .modal-close:focus-visible {
            outline: 2px solid #58a6ff;
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            .modal-overlay,
            .modal-dialog {
                transition: none;
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .container {
                max-width: 100%;
            }
            h1 {
                font-size: 1.4rem;
            }
            .card {
                padding: 1rem;
            }
            button {
                font-size: 0.85rem;
                padding: 0.5rem 0.9rem;
            }
            .btn-sm {
                font-size: 0.75rem;
                padding: 0.4rem 0.6rem;
            }
            .card .btn-sm {
                padding: 0.4rem 0.6rem;
                height: 32px;
            }
            .card button {
                height: 32px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0.75rem;
            }
            h1 {
                font-size: 1.2rem;
            }
            .subtitle {
                font-size: 0.9rem;
            }
            .warning {
                padding: 0.8rem 0.9rem;
                font-size: 0.85rem;
            }
            .card h2 {
                font-size: 1rem;
            }
            .card h3 {
                font-size: 0.95rem;
            }
            textarea {
                font-size: 0.8rem;
            }
            .result-value {
                padding: 0.4rem 0.5rem;
            }
            .result-value code {
                font-size: 0.75rem;
            }
            /* Stack buttons vertically on very small screens */
            .card div[style*="display:flex"] {
                flex-direction: column;
                gap: 0.4rem;
            }
            .card div[style*="display:flex"] button {
                width: 100%;
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sticky top navigation bar -->
    <header class="topbar" role="banner">
        <div class="topbar-inner">
            <div class="topbar-left">
                <img src="./assets/favicon-32x32.png" alt="Enjin" class="site-logo">
                <div class="topbar-text">
                    <div class="topbar-title">Enjin Snap Wallet Exporter</div>
                </div>
            </div>
            <div class="topbar-actions">
                <button id="aboutBtn" class="btn-sm" aria-haspopup="dialog" aria-controls="modalOverlay">About</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="loading">
            <div class="spinner"></div>
            <p>Loading cryptographic libraries…</p>
            <p id="loadError" class="error" style="display:none; margin-top:1rem;"></p>
        </div>

        <div id="app" style="display:none">
            <!-- page header inside topbar (kept out of flow) -->

            <div id="securityNotice" class="warning">
                ⚠️ <strong>Security Warning:</strong> For maximum security, disconnect from the
                internet before entering your recovery phrase. This page runs entirely in your
                browser — no data is sent to any server.
            </div>

            <section class="card">
                <h2>Recovery Phrase</h2>
                <div class="input-hint">Please separate recovery phrase words with single spaces (no commas).</div>
                <textarea id="mnemonic" rows="3"
                          placeholder="Enter your 12 or 24 word recovery phrase…"
                          autocomplete="off" autocorrect="off" autocapitalize="off"
                          spellcheck="false" data-gramm="false"></textarea>
                <button id="deriveBtn">Derive Addresses</button>
            </section>

            <section id="results" class="card" style="display:none">
                <h2>Derived Addresses</h2>

                <div class="result-group">
                    <label>Ethereum (m/44'/60'/0'/0/0)</label>
                    <div class="result-value">
                        <code id="ethAddress"></code>
                        <button class="btn-sm field-icon copy-icon" data-copy="ethAddress" title="Copy" aria-label="Copy address">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="9" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M5 15V5a2 2 0 0 1 2-2h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                </div>

                <div class="result-group">
                    <label>Matrixchain sr25519 (blank derivation)</label>
                    <div class="result-value">
                        <code id="sr25519Address"></code>
                        <button class="btn-sm field-icon copy-icon" data-copy="sr25519Address" title="Copy" aria-label="Copy address">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="9" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M5 15V5a2 2 0 0 1 2-2h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                </div>

                <div class="result-group">
                    <label>Relaychain sr25519 (blank derivation)</label>
                    <div class="result-value">
                        <code id="sr25519RelayAddress"></code>
                        <button class="btn-sm field-icon copy-icon" data-copy="sr25519RelayAddress" title="Copy" aria-label="Copy address">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="9" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M5 15V5a2 2 0 0 1 2-2h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                </div>

                <div class="result-group">
                    <label>Enjin Snap ed25519 — Matrixchain (m/44'/1155' seed logic)</label>
                    <div class="result-value">
                        <code id="snapAddress"></code>
                        <button class="btn-sm field-icon copy-icon" data-copy="snapAddress" title="Copy" aria-label="Copy address">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="9" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M5 15V5a2 2 0 0 1 2-2h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                </div>

                <div class="result-group">
                    <label>Enjin Snap ed25519 — Relaychain (m/44'/1155' seed logic)</label>
                    <div class="result-value">
                        <code id="snapRelayAddress"></code>
                        <button class="btn-sm field-icon copy-icon" data-copy="snapRelayAddress" title="Copy" aria-label="Copy address">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="9" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M5 15V5a2 2 0 0 1 2-2h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                </div>

                <div class="result-group">
                    <label>Public Key</label>
                    <div class="result-value">
                        <code id="publicKey"></code>
                        <button class="btn-sm field-icon copy-icon" data-copy="publicKey" title="Copy" aria-label="Copy public key">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="9" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M5 15V5a2 2 0 0 1 2-2h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                </div>

                <div class="result-group">
                    <label>Private Key (hex seed)</label>
                    <div class="result-value sensitive">
                        <code id="privateKey"></code>
                        <button class="btn-sm field-icon toggle-icon" id="togglePk" aria-pressed="false" aria-label="Show private key" title="Show / Hide">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                        <button class="btn-sm field-icon copy-icon" data-copy="privateKey" title="Copy" aria-label="Copy private key">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="9" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M5 15V5a2 2 0 0 1 2-2h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                    <div class="field-note">Keep this a secret!</div>
                </div>
            </section>

            <section id="keystoreSection" class="card" style="display:none">
                <h2>Keystore Export</h2>
                <p style="color:#8b949e; font-size:0.85rem; margin-bottom:0.75rem;">
                    Export an encrypted JSON keystore for importing into the Enjin Wallet.
                </p>

                <div class="input-group">
                    <label for="password">Password <span class="required" aria-hidden="true">*</span></label>
                    <div class="password-row">
                           <div class="password-input-wrapper">
                               <input type="password" id="password" placeholder="Enter password for keystore"
                                   autocomplete="off" required aria-required="true">
                               <button type="button" id="togglePassword" class="input-icon" aria-pressed="false" aria-label="Show password" title="Show password"></button>
                           </div>
                    </div>
                    <div class="required-note">Password is required to export keystores.</div>
                </div>
                <!-- confirm password removed: single password used for keystore export -->
                <div class="card" style="margin-bottom:0.75rem;">
                    <h3 style="font-size:1rem; margin-bottom:0.5rem;">Ethereum v3 (Web3)</h3>
                    <p style="color:#3fb950; font-size:0.8rem; margin-bottom:0.5rem;">✓ Recommended — supported by Enjin Wallet</p>
                    <div style="display:flex; align-items: center; gap:0.5rem;">
                        <button id="downloadWeb3Btn" class="btn-download">Download Web3 Keystore</button>
                        <button class="btn-sm" id="copyWeb3Btn">Copy</button>
                    </div>
                    <div class="instructions">
                        <p><strong>Import into Enjin Wallet:</strong></p>
                        <ol>
                            <li>Go to <em>Settings → Wallets → Add Wallet → Import Wallet → Import Keystore</em></li>
                            <li>Paste the keystore content into the "Import Keystore" field</li>
                            <li>Enter the password in the "Encryption Password" field</li>
                        </ol>
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-size:1rem; margin-bottom:0.5rem;">Polkadot-style (scrypt + xsalsa20-poly1305)</h3>
                    <p style="color:#ff4d4f; font-size:0.8rem; margin-bottom:0.5rem;">⚠ Not supported by Enjin Wallet</p>
                    <div style="display:flex; align-items: center; gap:0.5rem;">
                        <button id="downloadPolkadotBtn" class="btn-download">Download Polkadot Keystore</button>
                        <button class="btn-sm" id="copyPolkadotBtn">Copy</button>
                    </div>
                    <div class="instructions">
                        <p><strong>Note:</strong> Enjin Wallet does not currently support this format.</p>
                        <p>This format is compatible with Polkadot.js and other Substrate-based wallets.</p>
                    </div>
                </div>

                <p id="keystoreStatus"></p>
            </section>

        </div>
    </div>

    <footer class="footerbar" role="contentinfo">
        <div class="footer-inner">
            <div class="footer-text">Enjin Snap Wallet Exporter &middot; <a href="https://github.com/bladzv/enjin-snap-wallet-exporter/blob/main/LICENSE" style="color:#58a6ff;" target="_blank">MIT License</a> &middot; <a href="https://github.com/bladzv/enjin-snap-wallet-exporter" style="color:#58a6ff;" target="_blank">GitHub</a></div>
        </div>
    </footer>

    <!-- Modal Container -->
    <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-dialog" style="position:relative;">
            <div class="modal-header">
                <div class="modal-icon" id="modalIcon"></div>
                <h3 class="modal-title" id="modalTitle"></h3>
                <button class="modal-close" id="modalCloseX" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <p>Derive addresses and export keys of Enjin Snap wallet address based on your recovery phrase.</p>
                <p>This tool derives Ethereum (BIP-44) and Enjin Snap ed25519 addresses (Matrixchain and Relaychain), displays public keys, and can export encrypted keystores compatible with the Enjin Wallet.</p>
                <p>Runs entirely in your browser — no data is transmitted to any server. For maximum security, run offline and close this page after use.</p>
            </div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- Load Polkadot UMD bundles for offline sr25519 support -->
    <script src="./libs/@polkadot_util@13.4.4/bundle-polkadot-util.js"></script>
    <script src="./libs/@polkadot_util-crypto@13.4.4/bundle-polkadot-util-crypto.js"></script>
    <script>
        // Expose the UMD bundle as window.polkadotUtilCrypto for the module script
        if (typeof polkadotUtilCrypto !== 'undefined') {
            window.polkadotUtilCrypto = polkadotUtilCrypto;
        }
    </script>

    <script type="module">
        // ─── Modal utility ───────────────────────────────────────────────
        // Replaces browser alert() / confirm() with an accessible, styled
        // modal that follows UI/UX best practices (focus trap, Escape key,
        // ARIA roles, animations, reduced-motion support).
        const _modal = {
            overlay: () => document.getElementById('modalOverlay'),
            icon:    () => document.getElementById('modalIcon'),
            title:   () => document.getElementById('modalTitle'),
            body:    () => document.getElementById('modalBody'),
            footer:  () => document.getElementById('modalFooter'),
            closeX:  () => document.getElementById('modalCloseX'),
            _trigger: null,
            _resolve: null,
        };

        /**
         * Show a modal dialog.
         * @param {object} opts
         * @param {'error'|'warning'|'success'|'info'} opts.type
         * @param {string} opts.title
         * @param {string} opts.message — supports HTML
         * @param {string} [opts.confirmLabel='OK']
         * @param {string} [opts.cancelLabel]       — if set, a secondary button appears
         * @param {'primary'|'danger'} [opts.confirmStyle='primary']
         * @returns {Promise<boolean>} true = confirmed, false = cancelled / dismissed
         */
        function showModal({ type = 'info', title, message, confirmLabel = 'OK', cancelLabel, confirmStyle = 'primary' } = {}) {
            const icons = { error: '✕', warning: '⚠', success: '✓', info: 'ℹ' };

            _modal.icon().className  = 'modal-icon ' + type;
            _modal.icon().textContent = icons[type] || icons.info;
            _modal.title().textContent = title;
            _modal.body().innerHTML    = message;

            // Build footer buttons
            _modal.footer().innerHTML = '';
            if (cancelLabel) {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'modal-btn modal-btn-secondary';
                cancelBtn.textContent = cancelLabel;
                cancelBtn.addEventListener('click', () => closeModal(false));
                _modal.footer().appendChild(cancelBtn);
            }
            const confirmBtn = document.createElement('button');
            confirmBtn.className = `modal-btn modal-btn-${confirmStyle}`;
            confirmBtn.textContent = confirmLabel;
            confirmBtn.addEventListener('click', () => closeModal(true));
            _modal.footer().appendChild(confirmBtn);

            // Remember trigger element for focus return
            _modal._trigger = document.activeElement;

            // Show overlay
            const overlay = _modal.overlay();
            overlay.classList.add('is-visible');

            // Focus confirm button
            requestAnimationFrame(() => confirmBtn.focus());

            return new Promise(resolve => { _modal._resolve = resolve; });
        }

        function closeModal(result = false) {
            const overlay = _modal.overlay();
            overlay.classList.remove('is-visible');
            if (_modal._resolve) { _modal._resolve(result); _modal._resolve = null; }
            // Return focus to trigger element
            if (_modal._trigger && typeof _modal._trigger.focus === 'function') {
                _modal._trigger.focus();
                _modal._trigger = null;
            }
        }

        // Close via X button
        _modal.closeX().addEventListener('click', () => closeModal(false));

        // Close via backdrop click (non-critical modals)
        _modal.overlay().addEventListener('click', e => {
            if (e.target === _modal.overlay()) closeModal(false);
        });

        // Close via Escape key
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && _modal.overlay().classList.contains('is-visible')) {
                closeModal(false);
            }
        });

        // Trap focus within modal
        _modal.overlay().addEventListener('keydown', e => {
            if (e.key !== 'Tab') return;
            const focusable = _modal.overlay().querySelectorAll(
                'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
            );
            if (!focusable.length) return;
            const first = focusable[0];
            const last  = focusable[focusable.length - 1];
            if (e.shiftKey) {
                if (document.activeElement === first) { e.preventDefault(); last.focus(); }
            } else {
                if (document.activeElement === last) { e.preventDefault(); first.focus(); }
            }
        });

        // About button: open modal with the subtitle/about text
        const aboutBtn = document.getElementById('aboutBtn');
        if (aboutBtn) {
            aboutBtn.addEventListener('click', () => {
                showModal({
                    type: 'info',
                    title: 'About Enjin Snap Wallet Exporter',
                    message: '<p>Derive addresses and export keys of Enjin Snap wallet address based on your recovery phrase.</p>' +
                             '<p>This tool derives Ethereum (BIP-44) and Enjin Snap ed25519 addresses (Matrixchain and Relaychain), displays public keys, and can export encrypted keystores compatible with the Enjin Wallet.</p>' +
                             '<p>Runs entirely in your browser — no data is transmitted to any server. For maximum security, run offline and close this page after use.</p>',
                    confirmLabel: 'Close'
                });
            });
        }

        // ─── Local-first imports (vendor libs in ./libs/) with CDN fallback ──
        // This tries relative `./libs/...` files first so the page works fully offline
        let HDKey, mnemonicToSeedSync, validateMnemonic, wordlist, base58, secp256k1, keccak_256, blake2b, scryptAsync, nacl;

        async function tryImport(localPath, cdnPath) {
            try {
                return await import(localPath);
            } catch (e) {
                return await import(cdnPath);
            }
        }

        try {
            const bip32Module = await tryImport('./libs/@scure_bip32@1.6.2.js', 'https://cdn.jsdelivr.net/npm/@scure/bip32@1.6.2/+esm');
            const bip39Module = await tryImport('./libs/@scure_bip39@1.5.4.js', 'https://cdn.jsdelivr.net/npm/@scure/bip39@1.5.4/+esm');
            const bip39WordlistModule = await tryImport('./libs/@scure_bip39_wordlist_english.js', 'https://cdn.jsdelivr.net/npm/@scure/bip39@1.5.4/wordlists/english/+esm');
            const baseModule = await tryImport('./libs/@scure_base@1.2.4.js', 'https://cdn.jsdelivr.net/npm/@scure/base@1.2.4/+esm');
            const secp256k1Module = await tryImport('./libs/@noble_curves_secp256k1.js', 'https://cdn.jsdelivr.net/npm/@noble/curves@1.8.1/secp256k1/+esm');
            const sha3Module = await tryImport('./libs/@noble_hashes_sha3.js', 'https://cdn.jsdelivr.net/npm/@noble/hashes@1.7.1/sha3/+esm');
            const blake2bModule = await tryImport('./libs/@noble_hashes_blake2b.js', 'https://cdn.jsdelivr.net/npm/@noble/hashes@1.7.1/blake2b/+esm');
            const scryptModule = await tryImport('./libs/@noble_hashes_scrypt.js', 'https://cdn.jsdelivr.net/npm/@noble/hashes@1.7.1/scrypt/+esm');
            const naclModule = await tryImport('./libs/tweetnacl@1.0.3.js', 'https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/+esm');

            HDKey = bip32Module.HDKey;
            mnemonicToSeedSync = bip39Module.mnemonicToSeedSync;
            validateMnemonic = bip39Module.validateMnemonic;
            wordlist = bip39WordlistModule.wordlist;
            base58 = baseModule.base58;
            secp256k1 = secp256k1Module.secp256k1;
            keccak_256 = sha3Module.keccak_256;
            blake2b = blake2bModule.blake2b;
            scryptAsync = scryptModule.scryptAsync;
            nacl = naclModule.default || naclModule;
        } catch (e) {
            console.error('Failed to load cryptographic libraries (local or CDN):', e);
            throw new Error('Failed to load cryptographic libraries. For offline use, place the required +esm bundles in ./libs/ or open this page via a local HTTP server to use CDN fallbacks.');
        }

        // Show status message indicating libraries are loaded
        const notice = document.getElementById('securityNotice');
        notice.className = 'status';
        notice.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="vertical-align:middle;"><circle cx="12" cy="12" r="11" fill="#16a34a"/><path d="M6 12l4 4 8-8" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> <strong>Libraries Loaded</strong><p style="margin:0.5rem 0 0 0;">All cryptographic libraries have been loaded successfully. For maximum security, disconnect from the internet now and proceed with exporting your private keys and keystore file. Remember to close this page after use to maintain wallet security.</p>';

        // Focus the mnemonic textarea when the UI becomes available. Retry briefly if hidden.
        function focusMnemonic(retries = 10) {
            try {
                const el = document.getElementById('mnemonic');
                if (!el) return;
                const style = window.getComputedStyle(el);
                const isVisible = style.display !== 'none' && style.visibility !== 'hidden' && el.offsetParent !== null;
                if (isVisible) {
                    el.focus({ preventScroll: true });
                    const len = el.value ? el.value.length : 0;
                    el.setSelectionRange(len, len);
                } else if (retries > 0) {
                    setTimeout(() => focusMnemonic(retries - 1), 200);
                }
            } catch (e) {
                // silent
            }
        }

        // Call now and also on DOMContentLoaded as a fallback
        focusMnemonic();
        document.addEventListener('DOMContentLoaded', () => focusMnemonic());

        // ─── Optional: sr25519 via Polkadot WASM ─────────────────────
        let sr25519Available = false;
        let polkadotCrypto   = null;

        // sr25519 via Polkadot UMD bundle (works offline, no ESM resolution needed)
        // The bundle is loaded via script tag and exposes window.polkadotUtilCrypto
        if (typeof window.polkadotUtilCrypto !== 'undefined') {
            polkadotCrypto = window.polkadotUtilCrypto;
            try {
                if (typeof polkadotCrypto.cryptoWaitReady === 'function') {
                    await polkadotCrypto.cryptoWaitReady();
                    sr25519Available = true;
                } else if (polkadotCrypto.isReady) {
                    sr25519Available = true;
                }
            } catch (e) {
                console.warn('sr25519 WASM init failed:', e);
            }
        } else {
            // Fallback: try CDN if local bundle not available
            try {
                polkadotCrypto = await import('https://esm.sh/@polkadot/util-crypto@13.4.4');
                if (polkadotCrypto && typeof polkadotCrypto.cryptoWaitReady === 'function') {
                    await polkadotCrypto.cryptoWaitReady();
                    sr25519Available = true;
                }
            } catch (e) {
                console.warn('sr25519 not available (WASM failed to load):', e);
            }
        }

        // ─── Helpers ──────────────────────────────────────────────────
        const SS58_FORMAT = 1110;       // Enjin Matrixchain
        const SS58_RELAY_FORMAT = 2135;  // Enjin Relaychain

        function bytesToHex(bytes) {
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function concatBytes(...arrays) {
            const total = arrays.reduce((s, a) => s + a.length, 0);
            const out = new Uint8Array(total);
            let offset = 0;
            for (const a of arrays) { out.set(a, offset); offset += a.length; }
            return out;
        }

        function uint32LE(n) {
            const buf = new Uint8Array(4);
            new DataView(buf.buffer).setUint32(0, n, true);
            return buf;
        }

        /** SS58 encode a 32-byte public key with a network prefix ≥ 64 (2-byte prefix). */
        function ss58Encode(publicKey, prefix) {
            const byte1 = ((prefix & 0xfc) >> 2) | 0x40;
            const byte2 = (prefix >> 8) | ((prefix & 0x03) << 6);
            const prefixBytes = new Uint8Array([byte1, byte2]);

            const payload = concatBytes(prefixBytes, publicKey);
            const ss58Pre = new TextEncoder().encode('SS58PRE');
            const hashInput = concatBytes(ss58Pre, payload);
            const hash = blake2b(hashInput, { dkLen: 64 });
            const checksum = hash.slice(0, 2);

            return base58.encode(concatBytes(payload, checksum));
        }

        /** EIP-55 mixed-case checksum address. */
        function toChecksumAddress(address) {
            const addr = address.toLowerCase().replace('0x', '');
            const hashHex = bytesToHex(keccak_256(new TextEncoder().encode(addr)));
            let result = '0x';
            for (let i = 0; i < 40; i++) {
                result += parseInt(hashHex[i], 16) >= 8 ? addr[i].toUpperCase() : addr[i];
            }
            return result;
        }

        // ─── Derivation functions ─────────────────────────────────────

        function deriveEthereum(seed) {
            const root  = HDKey.fromMasterSeed(seed);
            const child = root.derive("m/44'/60'/0'/0/0");
            const pub   = secp256k1.getPublicKey(child.privateKey, false).slice(1); // uncompressed, no 04 prefix
            const hash  = keccak_256(pub);
            const addr  = '0x' + bytesToHex(hash.slice(-20));
            return toChecksumAddress(addr);
        }

        function deriveSr25519(mnemonic) {
            if (!sr25519Available) return null;
            const miniSecret = polkadotCrypto.mnemonicToMiniSecret(mnemonic);
            const pair       = polkadotCrypto.sr25519PairFromSeed(miniSecret);
            return {
                matrixchain: ss58Encode(pair.publicKey, SS58_FORMAT),
                relaychain:  ss58Encode(pair.publicKey, SS58_RELAY_FORMAT),
            };
        }

        function deriveEnjinSnap(seed) {
            // SLIP-10 secp256k1 at m/44'/1155'
            const root  = HDKey.fromMasterSeed(seed);
            const child = root.derive("m/44'/1155'");
            const privKeyHex = '0x' + bytesToHex(child.privateKey);

            // .slice(0, 32) then UTF-8 encode — replicates the snap's account.ts
            const seedStr   = privKeyHex.slice(0, 32);
            const seedBytes = new TextEncoder().encode(seedStr);

            // ed25519 keypair from seed
            const kp = nacl.sign.keyPair.fromSeed(seedBytes);

            return {
                address:      ss58Encode(kp.publicKey, SS58_FORMAT),
                relayAddress: ss58Encode(kp.publicKey, SS58_RELAY_FORMAT),
                publicKey:    kp.publicKey,
                seedBytes:    seedBytes,
            };
        }

        // ─── Keystore builder ─────────────────────────────────────────

        async function buildKeystore(publicKey, seedBytes, password) {
            const pkcs8Header  = new Uint8Array([
                0x30, 0x53, 0x02, 0x01, 0x01, 0x30, 0x05, 0x06,
                0x03, 0x2b, 0x65, 0x70, 0x04, 0x22, 0x04, 0x20
            ]);
            const pkcs8Divider = new Uint8Array([0xa1, 0x23, 0x03, 0x21, 0x00]);
            const plaintext    = concatBytes(pkcs8Header, seedBytes, pkcs8Divider, publicKey);

            // scrypt parameters (match Python/Polkadot.js usage — do not change)
            const N = 1 << 15, p = 1, r = 8, dkLen = 32;
            const salt  = nacl.randomBytes(32);
            const nonce = nacl.randomBytes(24);

            const passwordBytes = new TextEncoder().encode(password);

            // Try available scrypt implementations in order of preference:
            // 1) noble's scryptAsync (bundled above)
            // 2) polkadot util-crypto implementation (WASM) if present
            // This mirrors the Python script's approach of preferring a
            // standard scrypt implementation so the derived key matches
            // what Polkadot.js expects.
            let key;
            if (typeof scryptAsync === 'function') {
                key = await scryptAsync(passwordBytes, salt, { N, r, p, dkLen });
            } else if (polkadotCrypto && typeof polkadotCrypto.scrypt === 'function') {
                // polkadot util-crypto's scrypt API may accept similar args;
                // normalize to Uint8Array output
                const out = await polkadotCrypto.scrypt(passwordBytes, salt, { N, r, p, dkLen });
                key = new Uint8Array(out);
            } else {
                throw new Error('No scrypt implementation available in the browser. Ensure the page was loaded with the vendor libs.');
            }

            // Ensure key is Uint8Array of length 32
            if (!(key instanceof Uint8Array)) key = new Uint8Array(key);

            const encrypted = nacl.secretbox(plaintext, nonce, key);

            const encoded = concatBytes(salt, uint32LE(N), uint32LE(p), uint32LE(r), nonce, encrypted);
            const encodedB64 = btoa(String.fromCharCode(...encoded));

            const address = ss58Encode(publicKey, SS58_FORMAT);

            return {
                encoded: encodedB64,
                encoding: {
                    content: ['pkcs8', 'ed25519'],
                    type:    ['scrypt', 'xsalsa20-poly1305'],
                    version: '3'
                },
                address,
                meta: { name: 'Enjin Snap', whenCreated: Date.now() }
            };
        }

        // ─── Ethereum v3 Web3 keystore builder (scrypt + aes-128-ctr) ──
        async function buildWeb3Keystore(seedBytes, password) {
            // private key hex (no 0x prefix for storage)
            const privHex = bytesToHex(seedBytes);
            const privBytes = seedBytes;

            // derive address from private key using secp256k1
            const pub = secp256k1.getPublicKey(privBytes, false).slice(1);
            const addrHex = '0x' + bytesToHex(keccak_256(pub).slice(-20));
            const address = toChecksumAddress(addrHex);

            // scrypt params (common Ethereum keystore defaults)
            const N = 1 << 18; // 262144
            const r = 8;
            const p = 1;
            const dkLen = 32;

            const salt = nacl.randomBytes(32);
            const passwordBytes = new TextEncoder().encode(password);
            const derived = await scryptAsync(passwordBytes, salt, { N, r, p, dkLen });

            const cipherKey = derived.slice(0, 16);
            const macKey = derived.slice(16, 32);

            // iv for AES-CTR (16 bytes)
            const iv = nacl.randomBytes(16);

            // encrypt using WebCrypto AES-CTR
            const cryptoKey = await crypto.subtle.importKey('raw', cipherKey, { name: 'AES-CTR' }, false, ['encrypt']);
            const ctBuf = await crypto.subtle.encrypt({ name: 'AES-CTR', counter: iv, length: 128 }, cryptoKey, privBytes);
            const ciphertext = new Uint8Array(ctBuf);

            // mac = keccak256(macKey || ciphertext)
            const macBytes = keccak_256(concatBytes(macKey, ciphertext));

            // build kdf and crypto objects per Web3 keystore v3
            const kdfparams = { dklen: dkLen, salt: btoa(String.fromCharCode(...salt)), n: N, r: r, p: p };
            const cipherparams = { iv: btoa(String.fromCharCode(...iv)) };

            function toHex(arr) { return bytesToHex(arr); }

            const keystore = {
                version: 3,
                id: ([1e7]+-1e3+-4e3+-8e3+-1e11).toString().replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)),
                address: address.replace('0x',''),
                crypto: {
                    ciphertext: toHex(ciphertext),
                    cipherparams: { iv: toHex(iv) },
                    cipher: 'aes-128-ctr',
                    kdf: 'scrypt',
                    kdfparams: {
                        dklen: dkLen,
                        salt: toHex(salt),
                        n: N,
                        r: r,
                        p: p
                    },
                    mac: bytesToHex(macBytes)
                }
            };

            return keystore;
        }

        // ─── Clipboard helper ─────────────────────────────────────────

        async function copyText(text) {
            try { await navigator.clipboard.writeText(text); }
            catch { /* fallback — ignored in offline contexts */ }
        }

        // ─── State ────────────────────────────────────────────────────
        let currentSnap = null;   // { address, publicKey, seedBytes }
        let pkVisible   = false;
        let realPkText  = '';

        // ─── UI wiring ───────────────────────────────────────────────

        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display     = 'block';

        // If we reached here, all critical imports loaded successfully.
        // The global error handler below covers CDN failures.
        window.__importsLoaded = true;

        document.getElementById('deriveBtn').addEventListener('click', () => {
            const mnemonic = document.getElementById('mnemonic').value.trim();
            if (!mnemonic) return;

            if (!validateMnemonic(mnemonic, wordlist)) {
                showModal({
                    type: 'error',
                    title: 'Invalid Recovery Phrase',
                    message: 'Please enter a valid 12 or 24 word BIP-39 recovery phrase. Check for typos and ensure each word is separated by a single space.',
                    confirmLabel: 'Try Again',
                });
                return;
            }

            const seed = mnemonicToSeedSync(mnemonic);

            // Ethereum
            try {
                document.getElementById('ethAddress').textContent = deriveEthereum(seed);
            } catch (e) {
                document.getElementById('ethAddress').textContent = 'Error: ' + e.message;
            }

            // sr25519
            try {
                const sr = deriveSr25519(mnemonic);
                if (sr) {
                    document.getElementById('sr25519Address').textContent = sr.matrixchain;
                    document.getElementById('sr25519RelayAddress').textContent = sr.relaychain;
                } else {
                    document.getElementById('sr25519Address').textContent = 'Unavailable (sr25519 requires WASM — use Python script)';
                    document.getElementById('sr25519Address').classList.add('unavailable');
                    document.getElementById('sr25519RelayAddress').textContent = 'Unavailable';
                    document.getElementById('sr25519RelayAddress').classList.add('unavailable');
                }
            } catch (e) {
                document.getElementById('sr25519Address').textContent = 'Error: ' + e.message;
                document.getElementById('sr25519RelayAddress').textContent = 'Error: ' + e.message;
            }

            // Enjin Snap ed25519
            try {
                currentSnap = deriveEnjinSnap(seed);
                document.getElementById('snapAddress').textContent = currentSnap.address;
                document.getElementById('snapRelayAddress').textContent = currentSnap.relayAddress;
                document.getElementById('publicKey').textContent =
                    '0x' + bytesToHex(currentSnap.publicKey);
                realPkText = '0x' + bytesToHex(currentSnap.seedBytes);
                pkVisible = false;
                document.getElementById('privateKey').textContent = '••••••••••••••••';
            } catch (e) {
                document.getElementById('snapAddress').textContent = 'Error: ' + e.message;
                document.getElementById('snapRelayAddress').textContent = 'Error: ' + e.message;
            }

            document.getElementById('results').style.display        = 'block';
            document.getElementById('keystoreSection').style.display = 'block';
        });

        // Copy buttons
        document.querySelectorAll('[data-copy]').forEach(btn => {
            btn.addEventListener('click', () => {
                const id   = btn.dataset.copy;
                const text = id === 'privateKey' ? realPkText
                           : document.getElementById(id).textContent;
                copyText(text);
                // Preserve the original innerHTML (SVG icon) so we can restore it
                const origHTML = btn.innerHTML;
                // Temporary checkmark SVG feedback (keeps button size consistent)
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                setTimeout(() => btn.innerHTML = origHTML, 1200);
            });
        });

        // Toggle private key visibility (with modern icon swap)
        (function () {
            const svgEye = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            const svgEyeOff = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8 .92-1.86 2.3-3.5 4-4.9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 3l18 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            const toggle = document.getElementById('togglePk');
            const pkEl = document.getElementById('privateKey');
            if (!toggle || !pkEl) return;
            toggle.innerHTML = svgEye;
            toggle.addEventListener('click', function () {
                pkVisible = !pkVisible;
                pkEl.textContent = pkVisible ? realPkText : '••••••••••••••••';
                this.setAttribute('aria-pressed', String(pkVisible));
                this.title = pkVisible ? 'Hide private key' : 'Show private key';
                this.innerHTML = pkVisible ? svgEyeOff : svgEye;
            });
        })();

        // Export keystore
        // Helpers for download/copy actions for each keystore format
        async function produceKeystore(format, password) {
            if (format === 'web3') {
                return await buildWeb3Keystore(currentSnap.seedBytes, password);
            }
            return await buildKeystore(currentSnap.publicKey, currentSnap.seedBytes, password);
        }

        async function handleAction(format, action, btn) {
            const status = document.getElementById('keystoreStatus');
            status.textContent = '';
            status.className = '';

            if (!currentSnap) {
                status.textContent = 'Derive addresses first.';
                status.className = 'error';
                return;
            }

            const pw  = document.getElementById('password').value;

            if (!pw) { status.textContent = 'Password cannot be empty.'; status.className = 'error'; return; }

            btn.disabled = true;
            const origText = btn.textContent;
            btn.textContent = 'Working…';

            try {
                const keystore = await produceKeystore(format, pw);
                const json = JSON.stringify(keystore, null, 2);

                if (action === 'download') {
                    const blob = new Blob([json], { type: 'application/json' });
                    const url  = URL.createObjectURL(blob);
                    const a    = document.createElement('a');
                    const namePrefix = format === 'web3' ? 'enjin-snap-keystore-web3' : 'enjin-snap-keystore';
                    const address = keystore.address || (currentSnap.address || 'unknown');
                    const ts = Math.floor(Date.now() / 1000);
                    a.href = url;
                    a.download = `${namePrefix}-${address.slice(0,8)}-${ts}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    status.textContent = `${format === 'web3' ? 'Web3' : 'Polkadot'} keystore downloaded for ${address}`;
                    status.className = 'success';
                } else {
                    try { await navigator.clipboard.writeText(json); } catch (e) { await copyText(json); }
                    status.textContent = `${format === 'web3' ? 'Web3' : 'Polkadot'} keystore copied to clipboard`;
                    status.className = 'success';
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'error';
            } finally {
                btn.disabled = false;
                btn.textContent = origText;
            }
        }

        // Disable keystore action buttons until a password is provided
        function updateKeystoreButtons() {
            const pwField = document.getElementById('password');
            const pw = pwField ? (pwField.value || '') : '';
            const disabled = pw.trim() === '';
            ['downloadWeb3Btn','copyWeb3Btn','downloadPolkadotBtn','copyPolkadotBtn'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.disabled = disabled;
                el.setAttribute('aria-disabled', String(disabled));
            });
        }

        const pwEl = document.getElementById('password');
        if (pwEl) pwEl.addEventListener('input', updateKeystoreButtons);
        // initialize state
        updateKeystoreButtons();

        // Password unmask toggle (uses inline SVG icons placed inside the input)
        (function () {
            const svgEye = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            const svgEyeOff = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8 .92-1.86 2.3-3.5 4-4.9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 3l18 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            const toggle = document.getElementById('togglePassword');
            const pw = document.getElementById('password');
            if (!toggle || !pw) return;
            // initialize icon (masked state)
            toggle.innerHTML = svgEye;
            toggle.addEventListener('click', function () {
                const showing = pw.type === 'text';
                pw.type = showing ? 'password' : 'text';
                this.setAttribute('aria-pressed', String(!showing));
                this.title = showing ? 'Show password' : 'Hide password';
                this.innerHTML = showing ? svgEye : svgEyeOff;
            });
        })();

        // Wire buttons
        document.getElementById('downloadWeb3Btn').addEventListener('click', function () { handleAction('web3', 'download', this); });
        document.getElementById('copyWeb3Btn').addEventListener('click', function () { handleAction('web3', 'copy', this); });
        document.getElementById('downloadPolkadotBtn').addEventListener('click', function () { handleAction('polkadot', 'download', this); });
        document.getElementById('copyPolkadotBtn').addEventListener('click', function () { handleAction('polkadot', 'copy', this); });

        // ─── Memory hygiene ───────────────────────────────────────────
        // Clear sensitive data from memory and DOM on page unload
        window.addEventListener('beforeunload', () => {
            document.getElementById('mnemonic').value = '';
            document.getElementById('password').value = '';
            if (currentSnap) {
                if (currentSnap.seedBytes) currentSnap.seedBytes.fill(0);
                if (currentSnap.publicKey) currentSnap.publicKey.fill(0);
                currentSnap = null;
            }
            realPkText = '';
        });
    </script>
    <script>
        // Fallback: if the ES module fails to load (e.g. CDN 404),
        // show a helpful error instead of an infinite spinner.
        window.addEventListener('load', () => {
            if (!window.__importsLoaded) {
                const el = document.getElementById('loadError');
                if (el) {
                    el.style.display = 'block';
                    el.textContent = 'Failed to load cryptographic libraries. '
                        + 'For offline use, ensure you have an internet connection for the first load to cache the libraries, or run: python3 -m http.server 8000 and open http://localhost:8000/index.html. '
                        + 'Open the browser console (F12) for details.';
                }
            }
        });
    </script>
</body>
</html>
